#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
BINARY="$REPO_ROOT/target/release/brad-precommit"

# Ensure cargo is in PATH
if ! command -v cargo &>/dev/null; then
  [ -f "$HOME/.cargo/env" ] && source "$HOME/.cargo/env"
fi

# Build on demand if binary is missing or source is stale
if [ ! -f "$BINARY" ] || [ "$(find "$REPO_ROOT/tools/dev-cli/src" -newer "$BINARY" -print -quit 2>/dev/null)" ]; then
  cargo build -p dev-cli --release --bin brad-precommit --manifest-path "$REPO_ROOT/Cargo.toml" -q
fi

exec "$BINARY" "$@"
