#!/bin/sh
#
# Pre-commit hook:
#   1. Block direct commits to main (worktree workflow enforced)
#   2. Scan staged changes for secrets using gitleaks
#   3. Full validation pipeline (typecheck + lint + test + architecture)
#

# --- Worktree gate: reject commits directly on main ---
BRANCH="$(git symbolic-ref --short HEAD 2>/dev/null)"

if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  # Allow merge commits (git merge creates MERGE_HEAD)
  if git rev-parse MERGE_HEAD >/dev/null 2>&1; then
    : # merge commit — allow
  elif [ "$ALLOW_MAIN_COMMIT" = "1" ]; then
    : # explicit override — allow
  else
    echo ""
    echo "ERROR: Direct commits to main are not allowed."
    echo ""
    echo "All changes must be made in git worktrees:"
    echo "  git worktree add ../lifting-worktrees/<branch-name> -b <branch-name>"
    echo ""
    echo "See AGENTS.md for the full worktree workflow."
    echo ""
    echo "To override (merge commits, etc): ALLOW_MAIN_COMMIT=1 git commit ..."
    echo ""
    exit 1
  fi
fi

# --- Gitleaks: scan for secrets ---
if ! command -v gitleaks >/dev/null 2>&1; then
  echo "gitleaks not installed. Install with: brew install gitleaks"
  exit 1
fi

gitleaks protect --staged --verbose

# --- Full validation pipeline ---

echo ""
echo "Running quality checks..."

# 1. Validate all quality gates before commit
if ! npm run validate; then
  echo ""
  echo "ERROR: Validation failed. Fix failures before committing."
  echo "  Run 'npm run validate' to reproduce."
  exit 1
fi

echo ""
echo "All pre-commit checks passed."
