#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
BINARY="$REPO_ROOT/target/release/brad-precommit"
SOURCE_DIR="$REPO_ROOT/tools/dev-cli/src"
LEGACY_SCRIPT="$REPO_ROOT/hooks/pre-commit-legacy"

if [ "${BRAD_USE_RUST_PRECOMMIT:-1}" = "0" ]; then
  if [ -f "$LEGACY_SCRIPT" ]; then
    exec bash "$LEGACY_SCRIPT" "$@"
  fi

  echo "BRAD_USE_RUST_PRECOMMIT=0 requires hooks/pre-commit-legacy to exist" >&2
  exit 1
fi

if ! command -v cargo >/dev/null 2>&1; then
  if [ -f "$HOME/.cargo/env" ]; then
    # shellcheck disable=SC1091
    source "$HOME/.cargo/env"
  fi
fi

if [ ! -f "$BINARY" ] || [ -n "$(find "$SOURCE_DIR" -newer "$BINARY" -print -quit 2>/dev/null)" ]; then
  if ! cargo build -p dev-cli --manifest-path "$REPO_ROOT/Cargo.toml" --bin brad-precommit -q; then
    exit 1
  fi
fi

exec "$BINARY" "$@"
