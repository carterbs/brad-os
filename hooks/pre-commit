#!/bin/sh
#
# Pre-commit hook:
#   1. Block direct commits to main (worktree workflow enforced)
#   2. Scan staged changes for secrets using gitleaks
#

# --- Worktree gate: reject commits directly on main ---
BRANCH="$(git symbolic-ref --short HEAD 2>/dev/null)"

if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
  # Allow merge commits (git merge creates MERGE_HEAD)
  if git rev-parse MERGE_HEAD >/dev/null 2>&1; then
    : # merge commit — allow
  elif [ "$ALLOW_MAIN_COMMIT" = "1" ]; then
    : # explicit override — allow
  else
    echo ""
    echo "ERROR: Direct commits to main are not allowed."
    echo ""
    echo "All changes must be made in git worktrees:"
    echo "  git worktree add ../lifting-worktrees/<branch-name> -b <branch-name>"
    echo ""
    echo "See CLAUDE.md for the full worktree workflow."
    echo ""
    echo "To override (merge commits, etc): ALLOW_MAIN_COMMIT=1 git commit ..."
    echo ""
    exit 1
  fi
fi

# --- Gitleaks: scan for secrets ---
if ! command -v gitleaks >/dev/null 2>&1; then
  echo "gitleaks not installed. Install with: brew install gitleaks"
  exit 1
fi

gitleaks protect --staged --verbose

# --- Quick quality checks (typecheck + lint staged files) ---
# These catch the most common errors before they enter the repo.

echo ""
echo "Running quality checks..."

# 1. TypeScript compilation (incremental, fast for small changes)
if ! npx tsc -b; then
  echo ""
  echo "ERROR: TypeScript compilation failed. Fix type errors before committing."
  echo "  Run 'npm run typecheck' to see full output."
  exit 1
fi
echo "✓ TypeScript compilation passed"

# 2. ESLint on staged .ts files only (proportional to change size)
STAGED_TS=$(git diff --cached --name-only --diff-filter=ACM -- '*.ts' | grep -v '\.config\.ts$' | grep -v 'scripts/' || true)
if [ -n "$STAGED_TS" ]; then
  if ! echo "$STAGED_TS" | xargs npx eslint; then
    echo ""
    echo "ERROR: ESLint errors found in staged files."
    echo "  Run 'npm run lint:fix' to auto-fix, then re-stage."
    exit 1
  fi
  echo "✓ ESLint passed (staged files)"
else
  echo "✓ ESLint skipped (no staged .ts files)"
fi

echo ""
echo "All pre-commit checks passed."
